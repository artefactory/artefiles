#!/bin/sh

# Install Nerd Fonts: Fira Code, Source Code Pro, and Monaspace
# -e: exit on error
# -u: exit on unset variables
set -eu

# Define logging functions
log_task() {
  printf "\033[0;34m➔ %s\033[0m\n" "$1"
}

log_subtask() {
  printf "  \033[0;36m↪ %s\033[0m\n" "$1"
}

log_success() {
  printf "  \033[0;32m✓ %s\033[0m\n" "$1"
}

log_error() {
  printf "  \033[0;31m✗ %s\033[0m\n" "$1" >&2
}

# Check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Download directory
DOWNLOAD_DIR="$(mktemp -d)"
trap 'rm -rf "$DOWNLOAD_DIR"' EXIT

# Set fonts directory based on OS using chezmoi templating
{{ if eq .chezmoi.os "darwin" }}
# macOS fonts directory
FONTS_DIR="$HOME/Library/Fonts"
{{ else }}
# Linux fonts directory
FONTS_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONTS_DIR"
{{ end }}

log_task "Installing Nerd Fonts"

# Define fonts to install with their URLs
FONTS="FiraCode SourceCodePro Monaspace"
NERD_FONTS_VERSION="3.1.1"  # Specify version for stability

# Function to download and install a font
install_font() {
  local font_name="$1"

  log_subtask "Installing $font_name Nerd Font..."

  cd "$DOWNLOAD_DIR"

  # Construct download URL
  local font_url="https://github.com/ryanoasis/nerd-fonts/releases/download/v${NERD_FONTS_VERSION}/${font_name}.zip"

  # Download font
  if command_exists curl; then
    curl -fsSL "$font_url" -o "$font_name.zip"
  elif command_exists wget; then
    wget -q "$font_url" -O "$font_name.zip"
  else
    log_error "Neither curl nor wget found. Cannot download fonts."
    exit 1
  fi

  # Create temporary directory for extraction
  mkdir -p "$font_name"

  # Extract font files
  if command_exists unzip; then
    unzip -q "$font_name.zip" -d "$font_name"
  else
    log_error "unzip not found. Cannot extract font files."
    exit 1
  fi

  # Copy font files to fonts directory - ignoring errors for files that don't exist
  cp "$font_name"/*.ttf "$FONTS_DIR/" 2>/dev/null || true
  cp "$font_name"/*.otf "$FONTS_DIR/" 2>/dev/null || true

  log_success "$font_name Nerd Font installed"
}

# Install each font
for font in $FONTS; do
  install_font "$font"
done

# Update font cache on Linux
{{ if ne .chezmoi.os "darwin" }}
if command_exists fc-cache; then
  log_subtask "Updating font cache..."
  fc-cache -f
  log_success "Font cache updated"
fi
{{ end }}

log_success "Nerd Font installation complete"

# Update WezTerm configuration to use the installed fonts
log_task "Updating WezTerm configuration to use Nerd Fonts"
{{ if eq .chezmoi.os "darwin" }}
log_subtask "See ~/.config/wezterm/wezterm.lua to customize font settings"
echo "Now you can update your WezTerm configuration to use FiraCode Nerd Font, Source Code Pro Nerd Font, or Monaspace Nerd Font"
{{ else }}
log_subtask "See ~/.config/wezterm/wezterm.lua to customize font settings"
echo "Now you can update your WezTerm configuration to use FiraCode Nerd Font, Source Code Pro Nerd Font, or Monaspace Nerd Font"
{{ end }}
